<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teco Preparações</title>
</head>
<body>
<header class="container-fluid bg-black text-center">
    <nav class="navbar navbar-expand-lg bg-black">
        <div class="container-fluid">
          <a class="navbar-brand" href="#"><img src="Img/Logo_Teco/02.png" alt="Logo" width="300" height="80""></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon bg-danger"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
            <ul class="navbar-nav">
            
            <a href="painel.html" 
                class="btn btn-outline-danger position-absolute" 
                style="top: 20px; right: 20px;">
                Sair
            </a>
          </div>
        </div>
      </nav>
</header>

<main class="container">
<body class="text-muted bg-light">  
<section id="Services" style="margin-top: 5px;" class="clients section light-background text-center">
      <div class="container section-title text-danger" data-aos="fade-up" style="padding: 15px;"><br>
        </div> 
        <div class="py-3 text-center text-danger">
          <h2>CONTROLE DE ESTOQUE</h2>
        </div>
        <div class="col-md-7 col-lg-12">
            <h4 class="py-5">Cadastrar Item</h4>
            <form id="formEstoque" class="needs-validation" novalidate>
                </div>

                <div class="container text-center mt-2 mb-5">
                  <div class="row justify-content-center">
                    <div class="col-md-6">

                    <div class="input-group">
                      <input type="text" id="pesquisaProduto" class="form-control" placeholder="Código do Item...">
                      <button class="btn btn-danger" type="button" onclick="buscarProduto()">Pesquisar</button>
                    </div>

                </div>
              </div>
            </div>

        <div class="row g-5">
          <div class="col-md-5 col-lg-4 order-md-last col-12 col-mb-11 mb-3">
            <h4 class="d-flex justify-content-between align-items-center fs-6 fw-normal mb-1 text-secondary">
              <span class="text-secondary" style="height:0px";>Descrição</span>
            </h4>

        <div class="col-12 col-mb-11 mb-3"> 
          <label for="descricao" class="form-label"></label> 
            <textarea class="form-control mb-lg-8" id="descricao" rows="6"></textarea> 
              <div class="invalid-feedback"> Valid descrição is required.
        </div> 
        </div> 
        <div class="col-sm-5 col-md mt-2"></div> 
            <div class="input-group">
                <button class="w-100 btn btn-danger btn-lg" type="submit">Finalizar</button>
              </div>
          </div>
          <div class="col-md-7 col-lg-8">
            <div class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-sm-6">
                  <label for="nomeItem" class="form-label">Nome do Item</label>
                  <input type="text" class="form-control" id="nomeItem" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid nome item is required.
                  </div>
                </div>
    
                <div class="col-sm-6">
                  <label for="codigoItem" class="form-label">Codigo do item</label>
                  <input type="text" class="form-control" id="codigoItem" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid codigo item is required.
                  </div>
                </div>
                <div class="col-sm-6">
                  <label for="quantidadeEmEstoque" class="form-label">Quantidade em Estoque</label>
                  <input type="text" class="form-control" id="quantidadeEmEstoque" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid quantidade em estoque is required.
                  </div>
                </div>
    
                <div class="col-sm-6">
                  <label for="numeroDeSerie" class="form-label">Numero de Série</label>
                  <input type="text" class="form-control" id="numeroDeSerie" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid numero de serie is required.
                  </div>
                </div>
    
                <div class="col-sm-6">
                  <label for="dataEntrada" class="form-label">Data de Entrada</label>
                  <input type="date" class="form-control mb-2" id="dataEntrada" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid data entrada is required.
                  </div>
                </div>

                <div class="col-sm-6">
                  <label for="dataSaida" class="form-label">Data de Saída</label>
                  <input type="date" class="form-control mb-2" id="dataSaida" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    Valid data saida is required.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        </form>
      </main>
<br>
<section class="container-fluid">
    <table class="table table-warning table-striped table-hover table bordered border-warning">
        <thead class="table-secondary">
        <tr> 
            <th>
              ID
            </th>
            <th>
                Código
            </th>
            <th>
                Descrição
            </th>
            <th>
                Item
            </th>
            <th>
              Número de Série
            </th>
            <th>
              Quantidade em estoque
            </th>
            <th>
              Data de entrada
            </th>
            <th>
              Data de saída
            </th>
            <th>
              Ações
            </th>
        </tr>
        </thead>
        <tbody id="tabelaEstoque" class="table-group-divider">

        </tbody>
    </table> 
</section>

  <footer class="container-fluid mt-5 bg-black"> 
  </div>
  <div class="copyright text-center text-danger"><br>
    <p>© <span>Copyright</span> <strong class="px-1 sitename">Teco Preparações</strong> <span>All Rights Reserved</span> <span>2025</span></p>
  <div class="credits">
    Desenvolvido por Juliana Sousa<br><br>
  </div>
</div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
document.getElementById('formEstoque').addEventListener('submit', async function (e) {
    e.preventDefault();

    const dados = {
        item: document.getElementById('nomeItem').value,
        codigo: document.getElementById('codigoItem').value,
        quantidade: parseInt(document.getElementById('quantidadeEmEstoque').value), 
        numeroSerie: document.getElementById('numeroDeSerie').value,
        dataEntrada: document.getElementById('dataEntrada').value,
        dataSaida: document.getElementById('dataSaida').value,
        descricao: document.getElementById('descricao').value, 
    };

    try {
        const response = await fetch('/produtos', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
        }

        const result = await response.json();
        alert("Produto cadastrado com sucesso! ID: " + result.id);

        this.reset();
        
        carregarProdutos();

    } catch (error) {
        console.error('Erro ao cadastrar produto:', error);
        alert(`Falha ao cadastrar o produto. Verifique o console. Erro: ${error.message}`);
    }
});
</script>

<script>
// ⚡️ NOVA FUNÇÃO: Deletar produto
async function deletarProduto(id) {
    // Pede confirmação antes de deletar
    if (!confirm(`Tem certeza que deseja deletar o produto (ID: ${id})? Esta ação é irreversível.`)) {
        return; 
    }

    try {
        const response = await fetch(`produtos/${id}`, {
            method: "DELETE" // Usa o método DELETE para chamar a rota no servidor
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
        }

        const result = await response.json();
        alert(result.message);

        // Recarrega a lista para mostrar a exclusão
        carregarProdutos();

    } catch (error) {
        console.error('Erro ao deletar produto:', error);
        alert(`Falha ao deletar o produto. Erro: ${error.message}`);
    }
}


async function carregarProdutos(produtosParaExibir = null) {
    const tabela = document.getElementById("tabelaEstoque");
    tabela.innerHTML = ""; // Limpa a tabela antes de popular

    let produtos;

    if (produtosParaExibir) {
        produtos = produtosParaExibir; // Usa a lista de produtos fornecida (da busca)
    } else {
        // Carrega todos os produtos se não houver lista fornecida
        try {
            const response = await fetch(`/produtos`);
            if (!response.ok) {
                throw new Error(`Erro ao carregar lista. Status: ${response.status}`);
            }
            produtos = await response.json();
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
            tabela.innerHTML = `<tr><td colspan="12" class="text-center text-danger">Não foi possível carregar os produtos. Verifique se o servidor está rodando.</td></tr>`;
            return;
        }
    }


    if (produtos.length === 0) {
         tabela.innerHTML = `<tr><td colspan="12" class="text-center text-info">Nenhum produto encontrado.</td></tr>`;
         return;
    }

    produtos.forEach(prod => {
        tabela.innerHTML += `
            <tr>
                <td>${prod.id}</td>
                <td>${prod.codigo}</td>
                <td>${prod.descricao}</td>
                <td>${prod.item}</td>
                <td>${prod.numeroSerie}</td>
                <td>${prod.quantidade}</td>
                <td>${prod.dataEntrada}</td>
                <td>${prod.dataSaida}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deletarProduto(${prod.id})">Deletar</button>
                </td>
            </tr>
        `;
    });
}

// ⚡️ Função de Busca Atualizada para usar o novo carregarProdutos
async function buscarProduto() {
    const termoBusca = document.getElementById('pesquisaProduto').value.trim();

    if (!termoBusca) {
        carregarProdutos(); // Se o campo estiver vazio, recarrega a lista completa
        return;
    }

    try {
        // Usa a rota de busca do seu Back-end, conforme configurado na sua última alteração.
        const response = await fetch(`produtos/search?codigo=${termoBusca}`);
        
        if (!response.ok) {
            throw new Error(`Erro na busca. Status: ${response.status}`);
        }

        const produtos = await response.json();

        // Passa os produtos encontrados para a função de carregamento
        carregarProdutos(produtos); 
        
    } catch (error) {
        console.error('Erro ao buscar produtos:', error);
        const tabela = document.getElementById("tabelaEstoque");
        tabela.innerHTML = `<tr><td colspan="12" class="text-center text-danger">Falha ao realizar a busca.</td></tr>`;
    }
}

// Carregar a tabela ao abrir a página
carregarProdutos();
</script>
</body>
</html>